<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ECO EXPRESS - SISTEMA INTEGRADO</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* ================= ESTILOS GERAIS ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); min-height: 100vh; }

        /* Header */
        .header { background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .header-title { font-size: 24px; font-weight: bold; }
        .logo { width: 120px; transition: 0.3s; } .logo:hover { transform: scale(1.05); }

        /* Navega√ß√£o */
        .nav-tabs { display: flex; justify-content: center; gap: 20px; padding: 20px; background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%); }
        .nav-tab { padding: 15px 40px; font-size: 16px; font-weight: 700; border: 2px solid white; border-radius: 30px; cursor: pointer; background: rgba(255,255,255,0.2); color: white; transition: all 0.3s; }
        .nav-tab.active { background: white; color: #558B2F; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: translateY(-3px); }
        
        .container { max-width: 1800px; margin: 20px auto; padding: 0 20px; }
        .tab-pane { display: none; padding-bottom: 50px; }
        .tab-pane.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .loading-overlay.active { display: flex; }
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #7CB342; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ================= ESTILOS CHECKLIST ================= */
        .kpis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #7CB342; }
        .kpi-value { font-size: 32px; font-weight: bold; color: #333; }
        .kpi-label { font-size: 14px; color: #666; }
        
        .filters-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; cursor: pointer; }
        
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .chart-canvas { position: relative; height: 350px; }
        
        .table-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #424242; color: white; padding: 12px; text-align: left; cursor: pointer; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        .status-verde { background: #c8e6c9; color: #2e7d32; } .status-amarelo { background: #fff9c4; color: #f57f17; } .status-vermelho { background: #ffcdd2; color: #c62828; }

        .pendentes-section { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
        .pendentes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .pendente-card { background: #fff3f3; border-left: 4px solid #f44336; padding: 15px; border-radius: 8px; }
        .placa-badge { display: inline-block; background: white; border: 1px solid #f44336; padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #c62828; margin: 2px; }
        .placa-nao-consta { background: #e3f2fd; border-color: #2196f3; color: #1565c0; opacity: 0.8; }

        /* ================= ESTILOS TREINAMENTOS ================= */
        .treino-controls { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start; }
        .multi-select-container { position: relative; min-width: 250px; }
        .multi-select-btn { width: 100%; padding: 12px; background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #444; }
        .multi-select-dropdown { display: none; position: absolute; top: 105%; left: 0; width: 100%; max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; padding: 10px; }
        .multi-select-dropdown.show { display: block; }
        .checkbox-item { display: block; padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; } .checkbox-item:hover { background: #f5f5f5; } .checkbox-item input { margin-right: 10px; transform: scale(1.2); }
        .btn-action { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px; height: 45px; }
        .btn-excel { background: #27ae60; } .btn-update { background: #667eea; }
        .treino-kpis { display: flex; gap: 20px; margin-bottom: 30px; }
        .kpi-box-t { flex: 1; padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .kpi-val { font-size: 36px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center; gap:20px;">
            <img src="https://drive.google.com/thumbnail?id=1XLW90ZJH4VRX25n1_vpj5Ls5BwEavRvY&sz=w400" alt="Eco Express" class="logo" onerror="this.style.display='none'">
            <div>
                <div class="header-title">ECO EXPRESS</div>
                <div style="font-size:12px; opacity:0.9;">Sistema Integrado de Gest√£o</div>
            </div>
        </div>
        <img src="https://drive.google.com/thumbnail?id=1It3AAE7Ybl-K3PYmsalCWG02p9KW4_FI&sz=w400" alt="Mascote" style="width:80px;" onerror="this.style.display='none'">
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="mudarAba('checklist')">üìã CHECKLIST</button>
        <button class="nav-tab" onclick="mudarAba('treinamentos')">üéì TREINAMENTOS</button>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-size:18px; font-weight:bold;">Carregando dados...</div>
    </div>

    <div id="abaChecklist" class="tab-pane active">
        <div class="container">
            <div class="kpis-grid">
                <div class="kpi-card">
                    <div class="kpi-label">üöó Total Ve√≠culos</div>
                    <div class="kpi-value" id="kpiTotal">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">‚úÖ Realizados</div>
                    <div class="kpi-value" id="kpiRealizados">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">‚è≥ Pendentes</div>
                    <div class="kpi-value" id="kpiFaltando">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">üìä Taxa Geral</div>
                    <div class="kpi-value" id="kpiTaxa">-</div>
                </div>
            </div>

            <div class="filters-section">
                <h3>üîç Filtros Checklist</h3>
                <div class="filters-grid">
                    <select id="filterRegional" class="filter-select"><option value="TODOS">Regional: Todos</option></select>
                    <select id="filterSVC" class="filter-select"><option value="TODOS">SVC: Todos</option></select>
                    <select id="filterStatus" class="filter-select">
                        <option value="TODOS">Status: Todos</option>
                        <option value="verde">üü¢ Excelente</option>
                        <option value="amarelo">üü° Aten√ß√£o</option>
                        <option value="vermelho">üî¥ Cr√≠tico</option>
                        <option value="PENDENTE">‚ö†Ô∏è Pendentes</option>
                    </select>
                </div>
                <button onclick="clearChecklistFilters()" style="margin-top:15px; padding:8px 20px; cursor:pointer;">Limpar Filtros</button>
            </div>

            <div class="charts-section">
                <div class="chart-card">
                    <h3 style="margin-bottom:10px; color:#558B2F;">Performance Regional</h3>
                    <div class="chart-canvas"><canvas id="chartRegional"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 style="margin-bottom:10px; color:#558B2F;">Status Geral</h3>
                    <div class="chart-canvas"><canvas id="chartStatus"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 style="margin-bottom:10px; color:#2e7d32;">üèÜ Top 10 Melhores</h3>
                    <div class="chart-canvas"><canvas id="chartTop"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 style="margin-bottom:10px; color:#c62828;">‚ö†Ô∏è Top 10 Ofensores</h3>
                    <div class="chart-canvas"><canvas id="chartBottom"></canvas></div>
                </div>
            </div>

            <div class="table-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>üìã Detalhamento Checklist</h3>
                    <button onclick="exportChecklistExcel()" class="btn-action btn-excel">üì• Exportar Excel</button>
                </div>
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th onclick="sortTableCheck('regional')">REGIONAL ‚Üï</th>
                            <th onclick="sortTableCheck('svc')">SVC ‚Üï</th>
                            <th>TOTAL</th>
                            <th>N√ÉO CONSTA</th>
                            <th>REALIZADO</th>
                            <th>FALTANDO</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="pendentes-section">
                <h3 id="pendentesTitle" style="color:#c62828;">üö® Placas Pendentes</h3>
                <div id="pendentesGrid" class="pendentes-grid"></div>
            </div>
        </div>
    </div>

    <div id="abaTreinamentos" class="tab-pane">
        <div class="container">
            <div class="treino-controls">
                <div style="width: 100%; margin-bottom: 10px;">
                    <h2 style="color:#2c3e50;">Painel de Treinamentos</h2>
                    <p style="color:#666;">Filtre por m√∫ltiplos SVCs ou Cursos</p>
                </div>
                <div class="multi-select-container">
                    <button class="multi-select-btn" onclick="toggleDropdown('dd-svc')">
                        üè¢ Selecionar SVCs <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="dd-svc" class="multi-select-dropdown"></div>
                </div>
                <div class="multi-select-container">
                    <button class="multi-select-btn" onclick="toggleDropdown('dd-curso')">
                        üìö Selecionar Cursos <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="dd-curso" class="multi-select-dropdown"></div>
                </div>
                <button class="btn-action btn-update" onclick="carregarTreinamentos(true)"><i class="fas fa-sync"></i> Atualizar</button>
                <button class="btn-action btn-excel" onclick="exportarTreinoExcel()"><i class="fas fa-file-excel"></i> Exportar Dados</button>
            </div>

            <div class="treino-kpis">
                <div class="kpi-box-t" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="kpi-val" id="tkpi-vencidos">0</div>
                    <div>Motoristas Vencidos</div>
                </div>
                <div class="kpi-box-t" style="background: #34495e;">
                    <div class="kpi-val" id="tkpi-total">0</div>
                    <div>Total na Lista</div>
                </div>
            </div>

            <div class="chart-card" style="margin-bottom: 30px;">
                <div class="chart-canvas" style="height: 400px;">
                    <canvas id="graficoCursosTreino"></canvas>
                </div>
            </div>

            <div class="table-section">
                <h3 style="margin-bottom:15px;">üìã Listagem Filtrada</h3>
                <table style="width:100%;" id="tabelaTreino">
                    <thead>
                        <tr>
                            <th>Motorista</th>
                            <th>Driver ID</th>
                            <th>Facility (SVC)</th>
                            <th>Curso</th>
                            <th>Status</th>
                            <th>√öltima Rota</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p id="contadorTreino" style="margin-top:10px; color:#666;"></p>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        const SHEET_ID = '1OzrdPS7am7FSHOrVlT3qD5NBGm0TE1NERvRVKnFGb90';
        const GID_CHECKLIST = '1226817368';
        const SHEET_NAME_TREINO = 'Consolidado treinamentos';
        
        let dashData = null, chartsCheck = {};
        let dadosTreinoAll = [], dadosTreinoFiltered = [], chartTreinoInst = null, treinoLoaded = false;

        function mudarAba(aba) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            if (aba === 'checklist') {
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                document.getElementById('abaChecklist').classList.add('active');
            } else {
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                document.getElementById('abaTreinamentos').classList.add('active');
                if(!treinoLoaded) { carregarTreinamentos(); treinoLoaded = true; }
            }
        }

        window.addEventListener('load', () => {
            loadChecklist(); setInterval(() => loadChecklist(true), 300000);
        });

        window.onclick = function(event) {
            if (!event.target.matches('.multi-select-btn') && !event.target.matches('.multi-select-btn *')) {
                var dropdowns = document.getElementsByClassName("multi-select-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show') && !openDropdown.contains(event.target)) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        /* L√ìGICA CHECKLIST COMPLETA */
        async function loadChecklist(silent=false) {
            if(!silent) document.getElementById('loadingOverlay').classList.add('active');
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_CHECKLIST}&t=${Date.now()}`;
            try {
                const res = await fetch(url);
                const txt = await res.text();
                processCSV(txt);
            } catch (e) {
                try {
                    const res2 = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
                    const txt2 = await res2.text();
                    processCSV(txt2);
                } catch(err){ if(!silent) alert('Erro Checklist'); document.getElementById('loadingOverlay').classList.remove('active'); }
            }
        }

        function processCSV(csv) {
            const lines = []; let line='', q=false;
            for(let c of csv) { if(c==='"')q=!q; else if(c==='\n'&&!q){lines.push(line);line='';} else line+=c; }
            if(line)lines.push(line);
            const headers = lines[0].split(',').map(h=>h.replace(/"/g,'').trim());
            const data = [];
            for(let i=1; i<lines.length; i++) {
                const vals = []; let v='', q=false;
                for(let c of lines[i]) { if(c==='"')q=!q; else if(c===','&&!q){vals.push(v.trim());v='';} else v+=c; }
                vals.push(v.trim());
                if(vals[0]) { const row={}; headers.forEach((h,x)=>row[h]=vals[x]?vals[x].replace(/"/g,''):''); data.push(row); }
            }
            analyzeChecklist(data);
        }

        function analyzeChecklist(data) {
            const now = new Date();
            let dIni, dFim;
            if(now.getDate()<=15) { dIni=new Date(now.getFullYear(),now.getMonth(),1); dFim=new Date(now.getFullYear(),now.getMonth(),15,23,59,59); }
            else { dIni=new Date(now.getFullYear(),now.getMonth(),16); dFim=new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59); }

            const grouped = {};
            data.forEach(row => {
                const reg = row.REGIONAL||'N/A', svc = row.SVC||'N/A', placa = row.Placa||'', consta = (row['CONSTA NA VEC']||'').toUpperCase();
                const isNC = consta.includes('NO CONSTA')||consta.includes('N√ÉO CONSTA');
                const key = reg+'|'+svc;
                if(!grouped[key]) grouped[key]={regional:reg,svc:svc,total:0,nao_consta:0,validos:0,real:0,pends:[],nc_list:[]};
                grouped[key].total++;
                if(isNC) { grouped[key].nao_consta++; grouped[key].nc_list.push(placa); }
                else {
                    grouped[key].validos++;
                    let feito = false;
                    if(row.REALIZADO) {
                        let dt=null;
                        if(row.REALIZADO.includes('/')) { const p=row.REALIZADO.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/); if(p)dt=new Date(p[3],p[2]-1,p[1]); }
                        else if(!isNaN(row.REALIZADO)) dt=new Date((row.REALIZADO-25569)*86400*1000);
                        if(dt&&dt>=dIni&&dt<=dFim) feito=true;
                    }
                    if(feito) grouped[key].real++; else grouped[key].pends.push(placa);
                }
            });

            const arr = Object.values(grouped).map(i=>({...i, faltando:i.validos-i.real, perc:i.validos>0?(i.real/i.validos*100):0}));
            dashData = arr; updateCheckUI(arr);
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function updateCheckUI(data) {
            let flt = data;
            const reg = document.getElementById('filterRegional').value;
            const svc = document.getElementById('filterSVC').value;
            const sts = document.getElementById('filterStatus').value;

            if(reg!=='TODOS') flt=flt.filter(d=>d.regional===reg);
            if(svc!=='TODOS') flt=flt.filter(d=>d.svc===svc);
            if(sts!=='TODOS') {
                if(sts==='verde') flt=flt.filter(d=>d.perc>=80);
                else if(sts==='amarelo') flt=flt.filter(d=>d.perc>=50&&d.perc<80);
                else if(sts==='vermelho') flt=flt.filter(d=>d.perc<50);
                else if(sts==='PENDENTE') flt=flt.filter(d=>d.faltando>0);
            }

            const tot=flt.reduce((s,i)=>s+i.validos,0), rea=flt.reduce((s,i)=>s+i.real,0);
            document.getElementById('kpiTotal').innerText = tot;
            document.getElementById('kpiRealizados').innerText = rea;
            document.getElementById('kpiFaltando').innerText = tot-rea;
            document.getElementById('kpiTaxa').innerText = tot>0?(rea/tot*100).toFixed(1)+'%':'0%';

            if(document.getElementById('filterRegional').options.length===1) {
                [...new Set(data.map(d=>d.regional))].sort().forEach(r=>document.getElementById('filterRegional').add(new Option(r,r)));
                [...new Set(data.map(d=>d.svc))].sort().forEach(s=>document.getElementById('filterSVC').add(new Option(s,s)));
            }

            renderChecklistCharts(flt);
            const tb = document.getElementById('tableBody'); tb.innerHTML='';
            flt.sort((a,b)=>b.perc-a.perc).forEach(i=>{
                let c='#ffcdd2'; if(i.perc>=80)c='#c8e6c9'; else if(i.perc>=50)c='#fff9c4';
                tb.innerHTML+=`<tr><td>${i.regional}</td><td><b>${i.svc}</b></td><td>${i.total}</td>
                <td style="color:#666">${i.nao_consta}</td><td>${i.real}</td><td style="color:${i.faltando>0?'red':'green'}">${i.faltando}</td>
                <td style="background:${c}">${i.perc.toFixed(1)}%</td></tr>`;
            });

            const pg = document.getElementById('pendentesGrid'); pg.innerHTML='';
            const pends = flt.filter(i=>i.faltando>0);
            document.getElementById('pendentesTitle').innerText = `üö® Pendentes (${pends.reduce((s,i)=>s+i.pends.length,0)})`;
            pends.forEach(i=>{
                let html=`<div class="pendente-card"><strong>${i.svc}</strong><br>`;
                i.pends.forEach(p=>html+=`<span class="placa-badge">${p}</span>`);
                i.nc_list.forEach(p=>html+=`<span class="placa-badge placa-nao-consta">${p}</span>`);
                pg.innerHTML+=html+'</div>';
            });
        }

        // --- GR√ÅFICOS DO CHECKLIST (CORRIGIDOS) ---
        function renderChecklistCharts(data) {
            // 1. Regional
            const regMap={}; data.forEach(d=>{ if(!regMap[d.regional])regMap[d.regional]={t:0,r:0}; regMap[d.regional].t+=d.validos; regMap[d.regional].r+=d.real; });
            const lbls=Object.keys(regMap).sort(), vals=lbls.map(k=>regMap[k].t>0?(regMap[k].r/regMap[k].t*100):0);
            if(chartsCheck.reg)chartsCheck.reg.destroy();
            chartsCheck.reg = new Chart(document.getElementById('chartRegional'), {
                type:'bar', data:{labels:lbls, datasets:[{label:'% Real',data:vals,backgroundColor:'#7CB342'}]},
                options:{maintainAspectRatio:false, scales:{y:{max:100}}, plugins:{legend:{display:false}, datalabels:{color:'white',formatter:v=>v.toFixed(0)+'%'}}}
            });

            // 2. Status
            let sVerde=0, sAmarelo=0, sVermelho=0;
            data.forEach(d=>{ if(d.perc>=80)sVerde++; else if(d.perc>=50)sAmarelo++; else sVermelho++; });
            if(chartsCheck.status)chartsCheck.status.destroy();
            chartsCheck.status = new Chart(document.getElementById('chartStatus'), {
                type:'doughnut', data:{labels:['Excelente','Aten√ß√£o','Cr√≠tico'], datasets:[{data:[sVerde,sAmarelo,sVermelho], backgroundColor:['#4caf50','#fbc02d','#f44336']}]},
                options:{maintainAspectRatio:false, plugins:{datalabels:{color:'white',font:{weight:'bold'}}}}
            });

            // 3. Top 10
            const sorted = [...data].sort((a,b)=>b.perc-a.perc).slice(0,10);
            if(chartsCheck.top)chartsCheck.top.destroy();
            chartsCheck.top = new Chart(document.getElementById('chartTop'), {
                type:'bar', data:{labels:sorted.map(d=>d.svc), datasets:[{label:'% Real',data:sorted.map(d=>d.perc),backgroundColor:'#2e7d32'}]},
                options:{indexAxis:'y', maintainAspectRatio:false, plugins:{legend:{display:false}, datalabels:{color:'white',formatter:v=>v.toFixed(0)+'%'}}}
            });

            // 4. Bottom 10
            const bottom = [...data].sort((a,b)=>a.perc-b.perc).slice(0,10);
            if(chartsCheck.bot)chartsCheck.bot.destroy();
            chartsCheck.bot = new Chart(document.getElementById('chartBottom'), {
                type:'bar', data:{labels:bottom.map(d=>d.svc), datasets:[{label:'% Real',data:bottom.map(d=>d.perc),backgroundColor:'#c62828'}]},
                options:{indexAxis:'y', maintainAspectRatio:false, plugins:{legend:{display:false}, datalabels:{color:'white',formatter:v=>v.toFixed(0)+'%'}}}
            });
        }

        /* L√ìGICA TREINAMENTOS */
        function carregarTreinamentos(force=false) {
            document.getElementById('loadingOverlay').classList.add('active');
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME_TREINO)}&range=A:F&headers=1`;
            const script = document.createElement('script'); script.src = url;
            window.google = window.google||{}; window.google.visualization=window.google.visualization||{}; window.google.visualization.Query=window.google.visualization.Query||{};
            window.google.visualization.Query.setResponse = function(response) {
                if(response.status==='error'){alert('Erro Treino');return;}
                const rows = response.table.rows;
                dadosTreinoAll = rows.slice(1).map(r=>({
                    nome:r.c[0]?.v||'', driverId:r.c[1]?.v||'', facility:r.c[2]?.v||'', curso:r.c[3]?.v||'', ultimaRota:r.c[5]?.v||'', status:'Vencido'
                })).filter(d=>d.nome&&d.driverId);
                setupMultiFilters(); aplicarFiltrosTreino();
                document.getElementById('loadingOverlay').classList.remove('active');
            };
            document.head.appendChild(script);
        }

        function setupMultiFilters() {
            const setup = (arr, id) => {
                const con = document.getElementById(id);
                con.innerHTML = `<label class="checkbox-item" onclick="selectAll('${id}',true)"><b>Todos</b></label><label class="checkbox-item" onclick="selectAll('${id}',false)"><b>Limpar</b></label><hr>`;
                arr.forEach(i => con.innerHTML += `<label class="checkbox-item"><input type="checkbox" value="${i}" onchange="aplicarFiltrosTreino()"> ${i}</label>`);
            };
            setup([...new Set(dadosTreinoAll.map(d=>d.facility))].sort(), 'dd-svc');
            setup([...new Set(dadosTreinoAll.map(d=>d.curso))].sort(), 'dd-curso');
        }

        function toggleDropdown(id) { document.getElementById(id).classList.toggle("show"); }
        function selectAll(id, chk) { document.querySelectorAll(`#${id} input`).forEach(i=>i.checked=chk); aplicarFiltrosTreino(); }

        function aplicarFiltrosTreino() {
            const svcs = Array.from(document.querySelectorAll('#dd-svc input:checked')).map(c=>c.value);
            const curs = Array.from(document.querySelectorAll('#dd-curso input:checked')).map(c=>c.value);
            dadosTreinoFiltered = dadosTreinoAll.filter(d => (svcs.length===0||svcs.includes(d.facility)) && (curs.length===0||curs.includes(d.curso)));
            
            document.getElementById('tkpi-vencidos').innerText = dadosTreinoFiltered.length;
            document.getElementById('tkpi-total').innerText = dadosTreinoAll.length;
            document.getElementById('contadorTreino').innerText = `Mostrando ${dadosTreinoFiltered.length} registros`;

            const tb = document.querySelector('#tabelaTreino tbody'); tb.innerHTML='';
            dadosTreinoFiltered.slice(0,500).forEach(d => {
                tb.innerHTML += `<tr><td>${d.nome}</td><td>${d.driverId}</td><td>${d.facility}</td><td>${d.curso}</td><td style="color:#c62828;font-weight:bold;">Vencido</td><td>${d.ultimaRota}</td></tr>`;
            });
            atualizarGraficoTreino();
        }

        function atualizarGraficoTreino() {
            const counts={}; dadosTreinoFiltered.forEach(d=>counts[d.curso]=(counts[d.curso]||0)+1);
            const lbls=Object.keys(counts).sort((a,b)=>counts[b]-counts[a]).slice(0,10), vals=lbls.map(k=>counts[k]);
            const ctx=document.getElementById('graficoCursosTreino').getContext('2d');
            if(chartTreinoInst)chartTreinoInst.destroy();
            chartTreinoInst = new Chart(ctx, { type:'bar', data:{labels:lbls, datasets:[{label:'Pend√™ncias',data:vals,backgroundColor:'#e74c3c'}]}, options:{maintainAspectRatio:false, plugins:{legend:{display:false}}} });
        }

        // Listeners Checklist
        document.getElementById('filterRegional').onchange = () => updateCheckUI(dashData);
        document.getElementById('filterSVC').onchange = () => updateCheckUI(dashData);
        document.getElementById('filterStatus').onchange = () => updateCheckUI(dashData);
        function clearChecklistFilters(){ document.getElementById('filterRegional').value='TODOS'; document.getElementById('filterSVC').value='TODOS'; document.getElementById('filterStatus').value='TODOS'; updateCheckUI(dashData); }
        function sortTableCheck(k){ dashData.sort((a,b)=>(a[k]>b[k])?1:-1); updateCheckUI(dashData); }
        function exportChecklistExcel(){ if(!dashData)return; const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dashData),"Checklist"); XLSX.writeFile(wb,"Checklist_Eco.xlsx"); }
        function exportarTreinoExcel(){ if(dadosTreinoFiltered.length===0)return; const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dadosTreinoFiltered),"Treinamentos"); XLSX.writeFile(wb,"Treinamentos.xlsx"); }
    </script>
</body>
</html>
