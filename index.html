<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ECO EXPRESS CHECKLIST - Dashboard com Google Sheets</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
        }

        /* ========== ANIMA√á√ïES ========== */
        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes highlight {
            0%, 100% { background-color: transparent; box-shadow: none; }
            50% { background-color: rgba(124, 179, 66, 0.3); box-shadow: 0 0 20px rgba(124, 179, 66, 0.6); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(124, 179, 66, 0.5); }
            50% { box-shadow: 0 0 20px rgba(124, 179, 66, 0.8); }
        }

        /* Header Fixo */
        .header {
            background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
            animation: slideInDown 0.6s ease-out;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 120px;
            height: auto;
            transition: transform 0.3s;
        }

        .logo:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .mascote {
            width: 80px;
            height: auto;
            animation: pulse 2s infinite;
        }

        /* Bot√µes Flutuantes */
        /* REMOVIDO -         .floating-buttons { */
        /* REMOVIDO -             position: fixed; */
        /* REMOVIDO -             bottom: 30px; */
        /* REMOVIDO -             right: 30px; */
        /* REMOVIDO -             z-index: 999; */
        /* REMOVIDO -             display: flex; */
        /* REMOVIDO -             flex-direction: column; */
        /* REMOVIDO -             gap: 15px; */
        /* REMOVIDO -             animation: scaleIn 0.5s ease-out 0.3s both; */
        /* REMOVIDO -         } */
        /* REMOVIDO -  */
        /* REMOVIDO -         .floating-buttons.hidden { */
        /* REMOVIDO -             display: none; */
        /* REMOVIDO -         } */
        /* REMOVIDO -  */
        /* REMOVIDO -         .btn-float { */
        /* REMOVIDO -             background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%); */
        /* REMOVIDO -             color: white; */
        /* REMOVIDO -             border: none; */
        /* REMOVIDO -             padding: 15px 25px; */
        /* REMOVIDO -             border-radius: 50px; */
        /* REMOVIDO -             font-size: 16px; */
        /* REMOVIDO -             font-weight: 600; */
        /* REMOVIDO -             cursor: pointer; */
        /* REMOVIDO -             box-shadow: 0 4px 20px rgba(124, 179, 66, 0.4); */
        /* REMOVIDO -             display: flex; */
        /* REMOVIDO -             align-items: center; */
        /* REMOVIDO -             gap: 10px; */
        /* REMOVIDO -             transition: all 0.3s; */
        /* REMOVIDO -             white-space: nowrap; */
        /* REMOVIDO -         } */
        /* REMOVIDO -  */
        /* REMOVIDO -         .btn-float:hover { */
        /* REMOVIDO -             transform: translateY(-3px) scale(1.05); */
        /* REMOVIDO -             box-shadow: 0 6px 30px rgba(124, 179, 66, 0.6); */
        /* REMOVIDO -             animation: glow 1.5s infinite; */
        /* REMOVIDO -         } */
        /* REMOVIDO -  */
        /* REMOVIDO -         .btn-refresh { */
        /* REMOVIDO -             background: linear-gradient(135deg, #42A5F5 0%, #1976D2 100%); */
        /* REMOVIDO -             box-shadow: 0 4px 20px rgba(66, 165, 245, 0.4); */
        /* REMOVIDO -         } */
        /* REMOVIDO -  */
        /* REMOVIDO -         .btn-refresh:hover { */
        /* REMOVIDO -             box-shadow: 0 6px 30px rgba(66, 165, 245, 0.6); */
        /* REMOVIDO -         } */
        /* REMOVIDO -  */
        /* REMOVIDO -         .file-input { */
        /* REMOVIDO -             display: none; */
        /* REMOVIDO -         } */

        /* Container */
        .container {
            max-width: 1800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* KPIs */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #7CB342;
            transition: all 0.3s;
            animation: slideInDown 0.6s ease-out;
        }

        .kpi-card:nth-child(1) { animation-delay: 0.1s; }
        .kpi-card:nth-child(2) { animation-delay: 0.2s; }
        .kpi-card:nth-child(3) { animation-delay: 0.3s; }
        .kpi-card:nth-child(4) { animation-delay: 0.4s; }

        .kpi-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .kpi-icon {
            font-size: 36px;
            margin-bottom: 10px;
            display: inline-block;
            transition: transform 0.3s;
        }

        .kpi-card:hover .kpi-icon {
            transform: scale(1.2) rotate(10deg);
        }

        .kpi-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .kpi-trend {
            font-size: 12px;
            color: #7CB342;
            margin-top: 5px;
        }

        /* Filtros Interativos */
        .filters-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }

        .filters-title {
            font-size: 20px;
            font-weight: 600;
            color: #558B2F;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .filter-select:hover {
            border-color: #7CB342;
            transform: scale(1.02);
        }

        .filter-select:focus {
            border-color: #7CB342;
            outline: none;
            box-shadow: 0 0 0 3px rgba(124, 179, 66, 0.1);
        }

        .filter-select.active {
            border-color: #7CB342;
            background: #f9fff9;
            font-weight: 600;
            animation: pulse 0.5s;
        }

        .filter-info {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .clear-filters-btn {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e0e0e0;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .clear-filters-btn:hover {
            background: #e0e0e0;
            border-color: #bdbdbd;
            transform: scale(1.05);
        }

        /* Gr√°ficos */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            animation: scaleIn 0.8s ease-out;
        }

        .chart-card:nth-child(1) { animation-delay: 0.1s; }
        .chart-card:nth-child(2) { animation-delay: 0.2s; }
        .chart-card:nth-child(3) { animation-delay: 0.3s; }
        .chart-card:nth-child(4) { animation-delay: 0.4s; }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #558B2F;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
            cursor: pointer;
        }

        /* Gr√°ficos Top 10 - Altura aumentada para 10 SVCs */
        .chart-canvas.chart-horizontal {
            height: 450px;
        }

        /* Anima√ß√£o ao clicar no gr√°fico */
        .chart-clicked {
            animation: highlight 0.6s;
        }

        /* Tabela */
        .table-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: slideInUp 0.8s ease-out;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: #558B2F;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            background: #7CB342;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background: #558B2F;
            transform: scale(1.05);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #424242;
            color: white;
            position: sticky;
            top: 0;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: all 0.3s;
        }

        th:hover {
            background: #616161;
            transform: scale(1.02);
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f5f5f5;
            transform: scale(1.01);
        }

        td {
            padding: 12px 15px;
            font-size: 14px;
        }

        .regional-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .regional-tag:hover {
            transform: scale(1.1);
        }

        .status-verde {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .status-amarelo {
            background: #fff9c4;
            color: #f57f17;
        }

        .status-vermelho {
            background: #ffcdd2;
            color: #c62828;
        }

        .cell-center {
            text-align: center;
        }

        .cell-bold {
            font-weight: 600;
        }

        /* Placas Pendentes */
        .pendentes-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: slideInUp 1s ease-out;
        }

        .pendentes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pendentes-title {
            font-size: 20px;
            font-weight: 600;
            color: #c62828;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pendentes-count {
            background: #ffcdd2;
            color: #c62828;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .pendentes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .pendente-card {
            background: #fff3f3;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease-out;
        }

        .pendente-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
        }

        .pendente-regional {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .pendente-svc {
            font-size: 16px;
            font-weight: bold;
            color: #c62828;
            margin-bottom: 10px;
        }

        .pendente-placas {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .placa-badge {
            background: white;
            border: 1px solid #f44336;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            color: #c62828;
            transition: all 0.3s;
        }

        .placa-badge:hover {
            transform: scale(1.1);
            background: #ffcdd2;
        }
        
        /* Placa PENDENTE (vermelha - padr√£o) */
        .placa-badge.placa-pendente {
            background: white;
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .placa-badge.placa-pendente:hover {
            background: #ffcdd2;
        }
        
        /* Placa N√ÉO CONSTA (cinza/azul) */
        .placa-badge.placa-nao-consta {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            font-style: italic;
            opacity: 0.8;
        }
        
        .placa-badge.placa-nao-consta:hover {
            background: #bbdefb;
            opacity: 1;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            animation: scaleIn 0.5s;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #7CB342;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #558B2F;
            font-weight: 600;
        }

        /* Dashboard Content */
        .dashboard-content {
            display: none;
        }

        .dashboard-content.active {
            display: block;
        }

        /* Welcome Screen */
        .welcome-screen {
            background: white;
            padding: 60px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 50px auto;
            max-width: 600px;
            animation: scaleIn 0.8s ease-out;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: bold;
            color: #558B2F;
            margin-bottom: 15px;
        }

        .welcome-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .btn-start {
            background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(124, 179, 66, 0.3);
            transition: all 0.3s;
        }

        .btn-start:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 25px rgba(124, 179, 66, 0.4);
        }

        /* Melhorias para touch em celular/tablet */
        button, .btn-export, .upload-btn, .filter-select {
            -webkit-tap-highlight-color: rgba(124, 179, 66, 0.3);
            touch-action: manipulation;
        }

        /* Scroll suave no mobile */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Fix para Safari iOS */
        input, select, textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .logo {
                width: 100px;
            }
            
            .header-title {
                font-size: 20px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }

            .mascote {
                display: none;
            }
            
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .floating-buttons {
                bottom: 15px;
                right: 15px;
            }
            
            .btn-float {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
                font-size: 11px;
            }
            
            .chart-canvas.chart-horizontal {
                height: 350px;
            }
        }

        @media print {
            .floating-buttons, .filters-section {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <img src="https://drive.google.com/thumbnail?id=1XLW90ZJH4VRX25n1_vpj5Ls5BwEavRvY&sz=w400" alt="Eco Express" class="logo" onerror="this.style.display='none'">
            <div>
                <div class="header-title">ECO EXPRESS CHECKLIST</div>
                <div class="header-subtitle" id="headerSubtitle">
                    üåø Dashboard Interativo de An√°lise
                </div>
                <div class="header-subtitle" id="headerUpdate" style="font-size: 11px; opacity: 0.8; margin-top: 3px;">
                    üìÖ √öltima atualiza√ß√£o: --
                </div>
            </div>
        </div>
        <img src="https://drive.google.com/thumbnail?id=1It3AAE7Ybl-K3PYmsalCWG02p9KW4_FI&sz=w400" alt="Mascote" class="mascote" onerror="this.style.display='none'">
    </div>


    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Carregando dados do Google Sheets... üîÑ</div>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Welcome -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-icon">üöÄ</div>
            <div class="welcome-title">Bem-vindo ao ECO EXPRESS CHECKLIST!</div>
            <div class="welcome-text" id="welcomeText">
                Carregando dados automaticamente do Google Sheets...<br>
                Clique nos gr√°ficos para filtrar e clique novamente para remover o filtro.
            </div>
            <div style="margin-top: 30px; display: none;" id="uploadOption">
                <button class="btn-start" onclick="document.getElementById('fileInput').click()">
                    üìÅ Fazer Upload de Excel
                </button>
                <div style="font-size: 12px; color: #999; margin-top: 15px;">
                    Arraste e solte o arquivo Excel aqui ou clique no bot√£o acima
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- KPIs -->
            <div class="kpis-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">üöó</div>
                    <div class="kpi-label">Total de Ve√≠culos</div>
                    <div class="kpi-value" id="kpiTotal">-</div>
                    <div class="kpi-trend">no sistema</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">‚úÖ</div>
                    <div class="kpi-label">Realizados</div>
                    <div class="kpi-value" id="kpiRealizados">-</div>
                    <div class="kpi-trend" id="kpiRealizadosTrend">na quinzena</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">‚è≥</div>
                    <div class="kpi-label">Pendentes</div>
                    <div class="kpi-value" id="kpiFaltando">-</div>
                    <div class="kpi-trend">faltando</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìä</div>
                    <div class="kpi-label">Taxa Geral</div>
                    <div class="kpi-value" id="kpiTaxa">-</div>
                    <div class="kpi-trend">percentual</div>
                </div>
            </div>

            <!-- Filtros Interativos -->
            <div class="filters-section">
                <div class="filters-title">
                    <span>üîç</span>
                    <span>Filtros Interativos</span>
                    <span style="font-size: 12px; color: #999; font-weight: 400;">(Clique nos gr√°ficos para filtrar - clique de novo para remover)</span>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">üìç Regional</label>
                        <select id="filterRegional" class="filter-select">
                            <option value="TODOS">Todos</option>
                        </select>
                        <div class="filter-info">Clique nas barras do gr√°fico Regional</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üîß SVC</label>
                        <select id="filterSVC" class="filter-select">
                            <option value="TODOS">Todos</option>
                        </select>
                        <div class="filter-info">Clique nas barras dos Top 10</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üéØ Status</label>
                        <select id="filterStatus" class="filter-select">
                            <option value="TODOS">Todos</option>
                            <option value="verde">üü¢ Excelente (‚â•80%)</option>
                            <option value="amarelo">üü° Aten√ß√£o (50-79%)</option>
                            <option value="vermelho">üî¥ Cr√≠tico (<50%)</option>
                        </select>
                        <div class="filter-info">Clique nas fatias do gr√°fico Pizza</div>
                    </div>
                </div>
                <button class="clear-filters-btn" onclick="clearAllFilters()">üîÑ Limpar Todos os Filtros</button>
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-title">
                        <span>üìä</span>
                        <span>Performance por Regional</span>
                        <span style="font-size: 11px; color: #999; font-weight: 400;">(Clique = filtra / Clique novamente = remove)</span>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="chartRegional"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        <span>üéØ</span>
                        <span>Distribui√ß√£o por Status</span>
                        <span style="font-size: 11px; color: #999; font-weight: 400;">(Clique = filtra / Clique novamente = remove)</span>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        <span>üèÜ</span>
                        <span>Top 10 Melhores SVC</span>
                        <span style="font-size: 11px; color: #999; font-weight: 400;">(Clique = filtra / Clique novamente = remove)</span>
                    </div>
                    <div class="chart-canvas chart-horizontal">
                        <canvas id="chartTop"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        <span>‚ö†Ô∏è</span>
                        <span>Top 10 Piores SVC</span>
                        <span style="font-size: 11px; color: #999; font-weight: 400;">(Clique = filtra / Clique novamente = remove)</span>
                    </div>
                    <div class="chart-canvas chart-horizontal">
                        <canvas id="chartBottom"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">üìã An√°lise Detalhada por Regional</div>
                    <div class="table-actions">
                        <button class="btn-export" onclick="exportToExcel()">üì• Exportar Excel</button>
                        <button class="btn-export" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('regional')">REGIONAL ‚Üï</th>
                                <th onclick="sortTable('svc')">SVC ‚Üï</th>
                                <th onclick="sortTable('total_carros')" class="cell-center">TOTAL ‚Üï</th>
                                <th onclick="sortTable('quant_nao_consta')" class="cell-center">N√ÉO CONSTA ‚Üï</th>
                                <th onclick="sortTable('realizados')" class="cell-center">REALIZADOS ‚Üï</th>
                                <th onclick="sortTable('faltando')" class="cell-center">FALTANDO ‚Üï</th>
                                <th onclick="sortTable('perc_realizado')" class="cell-center">% REALIZADO ‚Üï</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Placas Pendentes -->
            <div class="pendentes-section" id="pendentesSection">
                <div class="pendentes-header">
                    <div class="pendentes-title">
                        <span>üö®</span>
                        <span>Listagem de Placas Pendentes</span>
                    </div>
                    <div class="pendentes-count" id="pendentesCount">0 placas</div>
                </div>
                <div class="pendentes-grid" id="pendentesGrid"></div>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        // CONFIGURA√á√ÉO DO GOOGLE SHEETS
        const SHEET_ID = '1OzrdPS7am7FSHOrVlT3qD5NBGm0TE1NERvRVKnFGb90';
        const GID = '1226817368';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

        let dashboardData = null;
        let fullData = null;
        let charts = {};
        let currentSort = { column: null, direction: 'asc' };
        let isViewMode = false;
        
        // CONTROLE DE FILTROS ATIVOS (para toggle)
        let activeFilters = {
            regional: null,
            svc: null,
            status: null
        };

        // Check view mode e carregar dados
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            isViewMode = urlParams.get('view') === '1';
            
            if (isViewMode) {
                // document.getElementById('floatingButtons').classList.add('hidden'); // REMOVIDO
            }
            
            // üîÑ SEMPRE CARREGAR DO GOOGLE SHEETS (tanto em view=1 quanto normal)
            console.log('üîÑ Carregando dados do Google Sheets automaticamente...');
            loadFromGoogleSheets();
            
            // üîÑ ATUALIZA√á√ÉO AUTOM√ÅTICA A CADA 5 MINUTOS
            setInterval(() => {
                console.log('üîÑ Atualiza√ß√£o autom√°tica: recarregando dados...');
                loadFromGoogleSheets(true); // true = atualiza√ß√£o silenciosa
            }, 5 * 60 * 1000); // 5 minutos
        });

        // FUN√á√ÉO PARA CARREGAR DADOS DO GOOGLE SHEETS - MULTI-M√âTODO
        async function loadFromGoogleSheets() {
            document.getElementById('loadingOverlay').classList.add('active');
            
            // M√âTODO 1: Tentar /export?format=csv
            const method1 = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/export?format=csv&gid=' + GID;
            
            // M√âTODO 2: Tentar /gviz/tq
            const method2 = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?tqx=out:csv&gid=' + GID;
            
            // M√âTODO 3: Usar proxy CORS
            const method3 = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(method1);
            
            const methods = [
                { name: 'M√©todo 1 (export/csv)', url: method1 },
                { name: 'M√©todo 2 (gviz/tq)', url: method2 },
                { name: 'M√©todo 3 (proxy CORS)', url: method3 }
            ];
            
            // Tentar cada m√©todo at√© funcionar
            for (let i = 0; i < methods.length; i++) {
                try {
                    console.log('üîÑ Tentando ' + methods[i].name + '...');
                    
                    const response = await fetch(methods[i].url);
                    
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    
                    const csvText = await response.text();
                    
                    // Verificar se √© CSV v√°lido
                    if (!csvText || csvText.length < 100 || !csvText.includes('REGIONAL')) {
                        throw new Error('CSV inv√°lido');
                    }
                    
                    console.log('‚úÖ ' + methods[i].name + ' funcionou!');
                    
                    // Parser CSV robusto (lida com v√≠rgulas dentro de aspas)
                    const lines = [];
                    let currentLine = '';
                    let insideQuotes = false;
                    
                    for (let char of csvText) {
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === '\n' && !insideQuotes) {
                            if (currentLine.trim()) {
                                lines.push(currentLine);
                            }
                            currentLine = '';
                        } else {
                            currentLine += char;
                        }
                    }
                    if (currentLine.trim()) lines.push(currentLine);
                    
                    // Processar headers
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                    
                    // Processar linhas
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = [];
                        let currentValue = '';
                        let insideQuotes = false;
                        
                        for (let char of lines[i]) {
                            if (char === '"') {
                                insideQuotes = !insideQuotes;
                            } else if (char === ',' && !insideQuotes) {
                                values.push(currentValue.trim());
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        values.push(currentValue.trim());
                        
                        // Verificar se a linha tem dados v√°lidos
                        if (values[0] && values[1] && values[2]) {
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                    }
                    
                    console.log('üìä Total de registros carregados:', data.length);
                    
                    // Processar dados
                    const processedData = analyzeData(data);
                    dashboardData = processedData;
                    fullData = data;
                    
                    // Atualizar dashboard
                    updateDashboard(processedData);
                    
                    document.getElementById('welcomeScreen').style.display = 'none';
                    document.getElementById('dashboardContent').classList.add('active');
                    document.getElementById('loadingOverlay').classList.remove('active');
                    
                    return; // Sucesso!
                    
                } catch (error) {
                    console.error('‚ùå ' + methods[i].name + ' falhou:', error.message);
                    
                    // Se for o √∫ltimo m√©todo, mostrar erro
                    if (i === methods.length - 1) {
                        document.getElementById('loadingOverlay').classList.remove('active');
                        
                        // Mostrar mensagem de erro com solu√ß√£o
                        const welcomeText = document.getElementById('welcomeText');
                        welcomeText.innerHTML = `
                            <div style="text-align: center; max-width: 700px; margin: 0 auto; padding: 30px;">
                                <h2 style="color: #e74c3c; margin-bottom: 25px;">‚ö†Ô∏è Planilha do Google Sheets Bloqueada</h2>
                                
                                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 25px; text-align: left;">
                                    <h3 style="color: #856404; margin-bottom: 15px;">üîí Problema de Permiss√£o</h3>
                                    <p style="color: #856404; line-height: 1.6;">A planilha do Google Sheets est√° <strong>bloqueada</strong> e n√£o pode ser acessada publicamente. Tentamos 3 m√©todos diferentes, mas todos falharam devido a restri√ß√µes de acesso.</p>
                                </div>
                                
                                <div style="background: #d1ecf1; border: 2px solid #17a2b8; border-radius: 10px; padding: 20px; margin-bottom: 25px; text-align: left;">
                                    <h3 style="color: #0c5460; margin-bottom: 15px;">üõ†Ô∏è Solu√ß√µes Poss√≠veis:</h3>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #0c5460; margin-bottom: 10px;">üìù Op√ß√£o 1: Publicar a Planilha na Web</h4>
                                        <ol style="color: #0c5460; line-height: 1.8; padding-left: 20px;">
                                            <li>Abra a planilha: <a href="https://docs.google.com/spreadsheets/d/1OzrdPS7am7FSHOrVlT3qD5NBGm0TE1NERvRVKnFGb90/edit" target="_blank" style="color: #0c5460; text-decoration: underline;">Clique aqui</a></li>
                                            <li>Menu: <strong>Arquivo ‚Üí Compartilhar ‚Üí Publicar na Web</strong></li>
                                            <li>Selecione: <strong>Planilha inteira</strong></li>
                                            <li>Formato: <strong>CSV</strong></li>
                                            <li>Clique em <strong>"Publicar"</strong></li>
                                            <li>Copie o link gerado e cole no c√≥digo (linha 1014)</li>
                                        </ol>
                                    </div>
                                    
                                    <div style="border-top: 1px solid #17a2b8; padding-top: 20px;">
                                        <h4 style="color: #0c5460; margin-bottom: 10px;">üì• Op√ß√£o 2: Baixar e Fazer Upload (TEMPOR√ÅRIO)</h4>
                                        <ol style="color: #0c5460; line-height: 1.8; padding-left: 20px;">
                                            <li>Baixe a planilha como Excel (.xlsx)</li>
                                            <li>Use o bot√£o abaixo para fazer upload</li>
                                            <li>Dashboard funcionar√° com os dados carregados</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 10px; padding: 15px; margin-bottom: 25px;">
                                    <p style="color: #721c24; margin: 0; font-weight: 600;">‚ö†Ô∏è <strong>Importante:</strong> Sem publicar na web, o dashboard <strong>N√ÉO</strong> poder√° atualizar automaticamente!</p>
                                </div>
                            </div>
                        `;
                        
                        // Mostrar bot√£o de upload tempor√°rio
                        document.getElementById('uploadOption').style.display = 'block';
                    }
                }
            }
        }

        // Drag & Drop
        document.body.addEventListener('dragover', (e) => e.preventDefault());
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            if (isViewMode) return;
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.match(/\.(xlsx|xls)$/)) {
                handleFile(files[0]);
            }
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            document.getElementById('loadingOverlay').classList.add('active');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    processExcel(workbook);
                } catch (error) {
                    alert('Erro: ' + error.message);
                    document.getElementById('loadingOverlay').classList.remove('active');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseExcelDate(excelDate) {
            if (!excelDate) return null;
            
            // Se j√° √© Date
            if (excelDate instanceof Date) return excelDate;
            
            // Se √© string no formato DD/MM/YYYY (comum no Google Sheets)
            if (typeof excelDate === 'string') {
                // Tentar formato brasileiro: DD/MM/YYYY
                const brMatch = excelDate.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (brMatch) {
                    const [, dia, mes, ano] = brMatch;
                    return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                }
                
                // Tentar formato ISO ou padr√£o
                const date = new Date(excelDate);
                if (!isNaN(date)) return date;
            }
            
            // Se √© n√∫mero (serial do Excel)
            if (typeof excelDate === 'number') {
                return new Date((excelDate - 25569) * 86400 * 1000);
            }
            
            return null;
        }

        function processExcel(workbook) {
            try {
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                const processedData = analyzeData(jsonData);
                dashboardData = processedData;
                fullData = jsonData;

                localStorage.setItem('ecoDashboardData', JSON.stringify(processedData));

                updateDashboard(processedData);

                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('dashboardContent').classList.add('active');
                document.getElementById('loadingOverlay').classList.remove('active');

            } catch (error) {
                alert('Erro: ' + error.message);
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function analyzeData(data) {
            const now = new Date();
            const day = now.getDate();
            const month = now.getMonth();
            const year = now.getFullYear();
            
            // üìÖ QUINZENA CORRETA: Detectar √∫ltimo dia do m√™s (28, 30 ou 31)
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            let quinzena, periodo, dataInicio, dataFim;
            
            if (day <= 15) {
                // 1¬™ QUINZENA: 01 a 15
                quinzena = 1;
                dataInicio = new Date(year, month, 1, 0, 0, 0);
                dataFim = new Date(year, month, 15, 23, 59, 59);
                periodo = `01/${(month + 1).toString().padStart(2, '0')} - 15/${(month + 1).toString().padStart(2, '0')}/${year}`;
            } else {
                // 2¬™ QUINZENA: 16 at√© √∫ltimo dia (28, 30 ou 31)
                quinzena = 2;
                dataInicio = new Date(year, month, 16, 0, 0, 0);
                dataFim = new Date(year, month, lastDay, 23, 59, 59);
                periodo = `16/${(month + 1).toString().padStart(2, '0')} - ${lastDay}/${(month + 1).toString().padStart(2, '0')}/${year}`;
            }

            console.log('üìÖ Per√≠odo da quinzena:', periodo);
            console.log('üìÖ Data de in√≠cio:', dataInicio.toLocaleDateString('pt-BR'));
            console.log('üìÖ Data de fim:', dataFim.toLocaleDateString('pt-BR'));
            console.log('üìÖ Hoje:', now.toLocaleDateString('pt-BR'));
            
            // üîç DEBUG: Mostrar primeiras 3 datas REALIZADO
            console.log('\nüîç DEBUG - Primeiras 3 datas REALIZADO:');
            for (let i = 0; i < Math.min(3, data.length); i++) {
                const row = data[i];
                const realizadoRaw = row.REALIZADO;
                const realizadoParsed = parseExcelDate(realizadoRaw);
                console.log(`  ${i+1}. Placa: ${row.Placa}`);
                console.log(`     REALIZADO (raw): ${realizadoRaw}`);
                console.log(`     REALIZADO (parsed): ${realizadoParsed ? realizadoParsed.toLocaleDateString('pt-BR') : 'null'}`);
                console.log(`     Dentro da quinzena? ${realizadoParsed && realizadoParsed >= dataInicio && realizadoParsed <= dataFim ? 'SIM \u2705' : 'N\u00c3O \u274c'}`);
            }

            const agrupado = {};
            
            // üìã PROCESSAR TODOS OS DADOS (incluindo N√ÉO CONSTA)
            data.forEach(row => {
                const regional = row.REGIONAL || 'N√ÉO INFORMADO';
                const svc = row.SVC || 'SEM SVC';
                const placa = row.Placa || 'SEM PLACA';
                const consta = (row['CONSTA NA VEC'] || '').toString().toUpperCase();
                const key = `${regional}|${svc}`;
                
                // Verificar se √© "N√ÉO CONSTA"
                const isNaoConsta = consta.includes('NO CONSTA') || 
                                    consta.includes('N√ÉO CONSTA') || 
                                    consta.includes('NAO CONSTA') ||
                                    consta === 'NO CONSTA';
                
                // Verificar se foi realizado NA QUINZENA
                const realizado = parseExcelDate(row.REALIZADO);
                const isRealizado = realizado && realizado >= dataInicio && realizado <= dataFim;
                
                if (!agrupado[key]) {
                    agrupado[key] = {
                        regional,
                        svc,
                        total: 0,               // Total GERAL (com N√ÉO CONSTA)
                        nao_consta: 0,          // Quantidade de N√ÉO CONSTA
                        total_validos: 0,       // Total sem N√ÉO CONSTA (para c√°lculo)
                        realizados: 0,          // Realizados na quinzena
                        placas_todas: [],       // Todas as placas
                        placas_nao_consta: [],  // Placas N√ÉO CONSTA
                        placas_validas: [],     // Placas v√°lidas (sem N√ÉO CONSTA)
                        placas_pendentes: []    // Pendentes (v√°lidas que n√£o foram realizadas)
                    };
                }
                
                // Contar TUDO
                agrupado[key].total++;
                agrupado[key].placas_todas.push(placa);
                
                if (isNaoConsta) {
                    // üö´ PLACA N√ÉO CONSTA
                    agrupado[key].nao_consta++;
                    agrupado[key].placas_nao_consta.push(placa);
                } else {
                    // ‚úÖ PLACA V√ÅLIDA (entra nos c√°lculos)
                    agrupado[key].total_validos++;
                    agrupado[key].placas_validas.push(placa);
                    
                    if (isRealizado) {
                        agrupado[key].realizados++;
                    } else {
                        agrupado[key].placas_pendentes.push(placa);
                    }
                }
            });

            // üìã CRIAR DETALHAMENTO
            const detalhamento = Object.values(agrupado).map(item => {
                const faltando = item.total_validos - item.realizados;
                const perc = item.total_validos > 0 
                    ? (item.realizados / item.total_validos * 100).toFixed(2)
                    : 0;
                
                let cor = 'vermelho';
                if (perc >= 80) cor = 'verde';
                else if (perc >= 50) cor = 'amarelo';

                // üîç DEBUG para SDF1
                if (item.svc === 'SDF1') {
                    console.log('\nüîç DEBUG SDF1:');
                    console.log('Total geral:', item.total);
                    console.log('N√£o consta:', item.nao_consta);
                    console.log('Total v√°lidos:', item.total_validos);
                    console.log('Realizados:', item.realizados);
                    console.log('Faltando:', faltando);
                    console.log('Percentual:', perc + '%');
                    console.log('Placas n√£o consta:', item.placas_nao_consta);
                    console.log('Placas pendentes:', item.placas_pendentes);
                }

                return {
                    regional: item.regional,
                    svc: item.svc,
                    total_carros: item.total,                    // Total GERAL (com N√ÉO CONSTA)
                    quant_nao_consta: item.nao_consta,           // Quantidade N√ÉO CONSTA
                    total_validos: item.total_validos,           // Total V√ÅLIDO (sem N√ÉO CONSTA)
                    realizados: item.realizados,                 // Realizados na quinzena
                    faltando: faltando,                          // Faltando (s√≥ v√°lidos)
                    perc_realizado: parseFloat(perc),            // % (s√≥ v√°lidos)
                    cor: cor,
                    placas_pendentes: item.placas_pendentes,     // Pendentes (s√≥ v√°lidas)
                    placas_nao_consta: item.placas_nao_consta    // Lista de N√ÉO CONSTA
                };
            });

            detalhamento.sort((a, b) => {
                const regionalCompare = a.regional.localeCompare(b.regional);
                if (regionalCompare !== 0) return regionalCompare;
                return b.perc_realizado - a.perc_realizado;
            });

            // üìã KPIs GLOBAIS (usando apenas V√ÅLIDOS, sem N√ÉO CONSTA)
            const total_geral = data.length;
            const total_nao_consta = detalhamento.reduce((sum, item) => sum + item.quant_nao_consta, 0);
            const total_validos = detalhamento.reduce((sum, item) => sum + item.total_validos, 0);
            const total_realizados = detalhamento.reduce((sum, item) => sum + item.realizados, 0);
            const total_faltando = total_validos - total_realizados;
            const taxa_geral = total_validos > 0 
                ? (total_realizados / total_validos * 100).toFixed(2)
                : 0;

            console.log('üìã Total GERAL:', total_geral);
            console.log('üö´ N√ÉO CONSTA:', total_nao_consta);
            console.log('‚úÖ V√ÅLIDOS:', total_validos);
            console.log('‚úÖ Realizados:', total_realizados);
            console.log('‚è≥ Faltando:', total_faltando);
            console.log('üìà Taxa:', taxa_geral + '%');

            const kpis = {
                total_veiculos: total_validos,      // Mostrar apenas V√ÅLIDOS
                total_realizados: total_realizados,
                total_faltando: total_faltando,
                taxa_geral: taxa_geral,
                total_nao_consta: total_nao_consta  // Adicionar para refer√™ncia
            };

            return {
                metadata: { 
                    periodo, 
                    quinzena, 
                    ultima_atualizacao: now.toLocaleString('pt-BR'),
                    lastDay: lastDay  // √öltimo dia do m√™s
                },
                kpis,
                detalhamento
            };
        }

        function updateDashboard(data) {
            document.getElementById('kpiTotal').textContent = data.kpis.total_veiculos;
            document.getElementById('kpiRealizados').textContent = data.kpis.total_realizados;
            document.getElementById('kpiFaltando').textContent = data.kpis.total_faltando;
            document.getElementById('kpiTaxa').textContent = data.kpis.taxa_geral + '%';
            document.getElementById('headerSubtitle').textContent = `üåø ${data.metadata.periodo}`;
            document.getElementById('headerUpdate').textContent = `üìÖ √öltima atualiza√ß√£o: ${data.metadata.ultima_atualizacao}`;

            populateFilters(data.detalhamento);
            applyFiltersAndUpdate();
        }

        function populateFilters(data) {
            const regionais = [...new Set(data.map(d => d.regional))].sort();
            const svcs = [...new Set(data.map(d => d.svc))].sort();

            const filterRegional = document.getElementById('filterRegional');
            const filterSVC = document.getElementById('filterSVC');

            filterRegional.innerHTML = '<option value="TODOS">Todos</option>';
            regionais.forEach(r => {
                filterRegional.innerHTML += `<option value="${r}">${r}</option>`;
            });

            filterSVC.innerHTML = '<option value="TODOS">Todos</option>';
            svcs.forEach(s => {
                filterSVC.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        // FILTROS INTERATIVOS - Atualiza tudo automaticamente
        document.getElementById('filterRegional').addEventListener('change', () => {
            activeFilters.regional = document.getElementById('filterRegional').value === 'TODOS' ? null : document.getElementById('filterRegional').value;
            applyFiltersAndUpdate();
        });
        
        document.getElementById('filterSVC').addEventListener('change', () => {
            activeFilters.svc = document.getElementById('filterSVC').value === 'TODOS' ? null : document.getElementById('filterSVC').value;
            applyFiltersAndUpdate();
        });
        
        document.getElementById('filterStatus').addEventListener('change', () => {
            const statusValue = document.getElementById('filterStatus').value;
            activeFilters.status = statusValue === 'TODOS' ? null : statusValue;
            applyFiltersAndUpdate();
        });

        function applyFiltersAndUpdate() {
            if (!dashboardData) return;

            const regional = document.getElementById('filterRegional').value;
            const svc = document.getElementById('filterSVC').value;
            const status = document.getElementById('filterStatus').value;

            let filtered = dashboardData.detalhamento;

            if (regional !== 'TODOS') {
                filtered = filtered.filter(d => d.regional === regional);
                document.getElementById('filterRegional').classList.add('active');
            } else {
                document.getElementById('filterRegional').classList.remove('active');
            }

            if (svc !== 'TODOS') {
                filtered = filtered.filter(d => d.svc === svc);
                document.getElementById('filterSVC').classList.add('active');
            } else {
                document.getElementById('filterSVC').classList.remove('active');
            }

            if (status !== 'TODOS') {
                filtered = filtered.filter(d => d.cor === status);
                document.getElementById('filterStatus').classList.add('active');
            } else {
                document.getElementById('filterStatus').classList.remove('active');
            }

            // Atualizar TUDO
            updateCharts(filtered);
            updateTable(filtered);
            updatePlacasPendentes(filtered);
            updateKPIsFromFiltered(filtered);
        }

        function updateKPIsFromFiltered(filtered) {
            const totalVeiculos = filtered.reduce((sum, d) => sum + d.total_carros, 0);
            const realizados = filtered.reduce((sum, d) => sum + d.realizados, 0);
            const faltando = totalVeiculos - realizados;
            const taxa = totalVeiculos > 0 ? ((realizados / totalVeiculos * 100).toFixed(2)) : 0;

            document.getElementById('kpiTotal').textContent = totalVeiculos;
            document.getElementById('kpiRealizados').textContent = realizados;
            document.getElementById('kpiFaltando').textContent = faltando;
            document.getElementById('kpiTaxa').textContent = taxa + '%';
        }

        function clearAllFilters() {
            document.getElementById('filterRegional').value = 'TODOS';
            document.getElementById('filterSVC').value = 'TODOS';
            document.getElementById('filterStatus').value = 'TODOS';
            
            document.getElementById('filterRegional').classList.remove('active');
            document.getElementById('filterSVC').classList.remove('active');
            document.getElementById('filterStatus').classList.remove('active');
            
            // Resetar activeFilters
            activeFilters = { regional: null, svc: null, status: null };
            
            if (dashboardData) {
                applyFiltersAndUpdate();
            }
        }

        // FUN√á√ÉO PARA APLICAR/REMOVER FILTRO (TOGGLE) AO CLICAR NO GR√ÅFICO
        function applyChartFilter(type, value) {
            // Toggle: se clicar no mesmo item, desativa o filtro
            if (activeFilters[type] === value) {
                // REMOVER filtro
                if (type === 'regional') {
                    document.getElementById('filterRegional').value = 'TODOS';
                    activeFilters.regional = null;
                } else if (type === 'svc') {
                    document.getElementById('filterSVC').value = 'TODOS';
                    activeFilters.svc = null;
                } else if (type === 'status') {
                    document.getElementById('filterStatus').value = 'TODOS';
                    activeFilters.status = null;
                }
            } else {
                // APLICAR filtro
                if (type === 'regional') {
                    document.getElementById('filterRegional').value = value;
                    activeFilters.regional = value;
                } else if (type === 'svc') {
                    document.getElementById('filterSVC').value = value;
                    activeFilters.svc = value;
                } else if (type === 'status') {
                    const statusMap = {
                        'üü¢ Excelente': 'verde',
                        'üü° Aten√ß√£o': 'amarelo',
                        'üî¥ Cr√≠tico': 'vermelho'
                    };
                    const statusValue = statusMap[value];
                    document.getElementById('filterStatus').value = statusValue || 'TODOS';
                    activeFilters.status = statusValue || null;
                }
            }
            
            applyFiltersAndUpdate();
        }

        function updateCharts(data) {
            // Regional
            const regionalData = {};
            data.forEach(d => {
                if (!regionalData[d.regional]) {
                    regionalData[d.regional] = { total: 0, realizados: 0 };
                }
                regionalData[d.regional].total += d.total_carros;
                regionalData[d.regional].realizados += d.realizados;
            });

            const regionalLabels = Object.keys(regionalData).sort();
            const regionalPerc = regionalLabels.map(r => 
                (regionalData[r].realizados / regionalData[r].total * 100).toFixed(2)
            );

            if (charts.regional) charts.regional.destroy();
            charts.regional = new Chart(document.getElementById('chartRegional'), {
                type: 'bar',
                data: {
                    labels: regionalLabels,
                    datasets: [{
                        label: 'Taxa (%)',
                        data: regionalPerc,
                        backgroundColor: regionalLabels.map(label => 
                            activeFilters.regional === label ? '#558B2F' : '#7CB342'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutBounce'
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: -5,
                            color: '#000',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value) => value + '%',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderRadius: 4,
                            padding: { top: 4, bottom: 4, left: 6, right: 6 }
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const regional = regionalLabels[index];
                            
                            // Anima√ß√£o ao clicar
                            const canvas = document.getElementById('chartRegional');
                            canvas.parentElement.classList.add('chart-clicked');
                            setTimeout(() => {
                                canvas.parentElement.classList.remove('chart-clicked');
                            }, 600);
                            
                            applyChartFilter('regional', regional);
                        }
                    }
                }
            });

            // Status
            const statusCount = { verde: 0, amarelo: 0, vermelho: 0 };
            data.forEach(d => statusCount[d.cor]++);

            const statusLabels = ['üü¢ Excelente', 'üü° Aten√ß√£o', 'üî¥ Cr√≠tico'];
            const statusColors = statusLabels.map((label, idx) => {
                const statusKey = ['verde', 'amarelo', 'vermelho'][idx];
                const isActive = activeFilters.status === statusKey;
                const baseColors = ['#4caf50', '#fbc02d', '#f44336'];
                return isActive ? '#2e7d32' : baseColors[idx];
            });

            if (charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('chartStatus'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: [statusCount.verde, statusCount.amarelo, statusCount.vermelho],
                        backgroundColor: statusColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeOutCubic'
                    },
                    plugins: {
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 18 },
                            formatter: (value) => value,
                            textShadowColor: 'rgba(0, 0, 0, 0.8)',
                            textShadowBlur: 4
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const statusLabel = statusLabels[index];
                            
                            // Anima√ß√£o ao clicar
                            const canvas = document.getElementById('chartStatus');
                            canvas.parentElement.classList.add('chart-clicked');
                            setTimeout(() => {
                                canvas.parentElement.classList.remove('chart-clicked');
                            }, 600);
                            
                            applyChartFilter('status', statusLabel);
                        }
                    }
                }
            });

            // Top 10
            const sorted = [...data].sort((a, b) => b.perc_realizado - a.perc_realizado);
            const top10 = sorted.slice(0, 10);

            if (charts.top) charts.top.destroy();
            charts.top = new Chart(document.getElementById('chartTop'), {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.svc),
                    datasets: [{
                        label: 'Taxa (%)',
                        data: top10.map(d => d.perc_realizado),
                        backgroundColor: top10.map(d => 
                            activeFilters.svc === d.svc ? '#2e7d32' : '#4caf50'
                        )
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, max: 100 } },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'center',
                            offset: -5,
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value) => value.toFixed(1) + '%',
                            textStrokeColor: '#000',
                            textStrokeWidth: 2
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const svc = top10[index].svc;
                            
                            // Anima√ß√£o ao clicar
                            const canvas = document.getElementById('chartTop');
                            canvas.parentElement.classList.add('chart-clicked');
                            setTimeout(() => {
                                canvas.parentElement.classList.remove('chart-clicked');
                            }, 600);
                            
                            applyChartFilter('svc', svc);
                        }
                    }
                }
            });

            // Bottom 10 - Ordenar por MENOR % realizado (mais ofensores)
            const dataWithPercFaltando = data.map(d => ({
                ...d,
                perc_faltando: (100 - d.perc_realizado).toFixed(2)
            }));
            
            const sortedByWorst = [...dataWithPercFaltando].sort((a, b) => b.perc_faltando - a.perc_faltando);
            const bottom10 = sortedByWorst.slice(0, 10);

            if (charts.bottom) charts.bottom.destroy();
            charts.bottom = new Chart(document.getElementById('chartBottom'), {
                type: 'bar',
                data: {
                    labels: bottom10.map(d => d.svc),
                    datasets: [{
                        label: '% Faltando (Ofensores)',
                        data: bottom10.map(d => parseFloat(d.perc_faltando)),
                        backgroundColor: bottom10.map(d => 
                            activeFilters.svc === d.svc ? '#c62828' : '#f44336'
                        )
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, max: 100 } },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'center',
                            offset: -5,
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value) => value.toFixed(1) + '%',
                            textStrokeColor: '#000',
                            textStrokeWidth: 2
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const svc = bottom10[index].svc;
                            
                            // Anima√ß√£o ao clicar
                            const canvas = document.getElementById('chartBottom');
                            canvas.parentElement.classList.add('chart-clicked');
                            setTimeout(() => {
                                canvas.parentElement.classList.remove('chart-clicked');
                            }, 600);
                            
                            applyChartFilter('svc', svc);
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="regional-tag">${row.regional}</span></td>
                    <td class="cell-bold">${row.svc}</td>
                    <td class="cell-center">${row.total_carros}</td>
                    <td class="cell-center">${row.quant_nao_consta}</td>
                    <td class="cell-center cell-bold">${row.realizados}</td>
                    <td class="cell-center cell-bold" style="color: ${row.faltando > 10 ? '#c62828' : '#666'}">${row.faltando}</td>
                    <td class="cell-center status-${row.cor}">
                        <strong>${row.perc_realizado.toFixed(2)}%</strong>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updatePlacasPendentes(data) {
            // Filtrar itens que t√™m placas pendentes OU placas n√£o consta
            const pendentes = data.filter(d => d.placas_pendentes.length > 0 || d.placas_nao_consta.length > 0);
            
            // Contar apenas placas V√ÅLIDAS pendentes (sem N√ÉO CONSTA)
            const totalPlacasValidas = pendentes.reduce((sum, d) => sum + d.placas_pendentes.length, 0);
            const totalNaoConsta = pendentes.reduce((sum, d) => sum + (d.placas_nao_consta ? d.placas_nao_consta.length : 0), 0);

            document.getElementById('pendentesCount').textContent = `${totalPlacasValidas} placas pendentes ${totalNaoConsta > 0 ? '+ ' + totalNaoConsta + ' n√£o consta' : ''}`;

            const grid = document.getElementById('pendentesGrid');
            grid.innerHTML = '';

            pendentes.sort((a, b) => a.regional.localeCompare(b.regional));

            pendentes.forEach(item => {
                const card = document.createElement('div');
                card.className = 'pendente-card';
                
                // HTML com placas PENDENTES (v√°lidas) e N√ÉO CONSTA (cinza)
                let placasHTML = '';
                
                // Placas PENDENTES (vermelhas)
                if (item.placas_pendentes && item.placas_pendentes.length > 0) {
                    placasHTML += item.placas_pendentes.map(p => 
                        `<span class="placa-badge placa-pendente">${p}</span>`
                    ).join('');
                }
                
                // Placas N√ÉO CONSTA (cinza/azul)
                if (item.placas_nao_consta && item.placas_nao_consta.length > 0) {
                    placasHTML += item.placas_nao_consta.map(p => 
                        `<span class="placa-badge placa-nao-consta" title="N√ÉO CONSTA - n√£o precisa fazer">üö´ ${p}</span>`
                    ).join('');
                }
                
                card.innerHTML = `
                    <div class="pendente-regional">${item.regional}</div>
                    <div class="pendente-svc">${item.svc}</div>
                    <div class="pendente-placas">
                        ${placasHTML}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function sortTable(column) {
            if (!dashboardData) return;

            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            const sorted = [...dashboardData.detalhamento].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (typeof valA === 'string') {
                    return currentSort.direction === 'asc' 
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                } else {
                    return currentSort.direction === 'asc'
                        ? valA - valB
                        : valB - valA;
                }
            });

            updateTable(sorted);
        }

        function exportToExcel() {
            if (!dashboardData) return;

            const ws = XLSX.utils.json_to_sheet(dashboardData.detalhamento);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'An√°lise');
            XLSX.writeFile(wb, `EcoExpress_Checklist_${dashboardData.metadata.periodo.replace(/\//g, '-')}.xlsx`);
        }
        // üîÑ SISTEMA DE ATUALIZA√á√ÉO AUTOM√ÅTICA
        let autoRefreshInterval = null;
        
        // SUBSTITUIR O EVENTO DE LOAD EXISTENTE PARA INCLUIR AUTO-REFRESH
        const originalLoad = window.onload;
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            isViewMode = urlParams.get('view') === '1';
            
            if (isViewMode) {
                // document.getElementById('floatingButtons').classList.add('hidden'); // REMOVIDO
            }
            
            // üîÑ SEMPRE CARREGAR DO GOOGLE SHEETS AUTOMATICAMENTE
            console.log('üîÑ Iniciando carregamento autom√°tico dos dados...');
            loadFromGoogleSheets();
            
            // üîÑ ATUALIZA√á√ÉO AUTOM√ÅTICA A CADA 5 MINUTOS
            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ Atualiza√ß√£o autom√°tica: recarregando dados do Google Sheets...');
                loadFromGoogleSheetsQuiet();
            }, 5 * 60 * 1000); // 5 minutos
            
            console.log('‚úÖ Sistema de atualiza√ß√£o autom√°tica ativado (a cada 5 minutos)');
        }, {once: false}); // Permite m√∫ltiplos listeners
        
        // FUN√á√ÉO PARA ATUALIZA√á√ÉO SILENCIOSA (sem mostrar loading)
        async function loadFromGoogleSheetsQuiet() {
            try {
                const method1 = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/export?format=csv&gid=' + GID;
                const response = await fetch(method1 + '&t=' + Date.now()); // Evita cache
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const csvText = await response.text();
                if (!csvText || !csvText.includes('REGIONAL')) throw new Error('CSV inv√°lido');
                
                // Parser CSV robusto
                const lines = [];
                let currentLine = '';
                let insideQuotes = false;
                
                for (let char of csvText) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === '\n' && !insideQuotes) {
                        if (currentLine.trim()) lines.push(currentLine);
                        currentLine = '';
                    } else {
                        currentLine += char;
                    }
                }
                if (currentLine.trim()) lines.push(currentLine);
                
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = [];
                    let currentValue = '';
                    let insideQuotes = false;
                    
                    for (let char of lines[i]) {
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            values.push(currentValue.trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue.trim());
                    
                    if (values[0] && values[1] && values[2]) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        data.push(row);
                    }
                }
                
                console.log('‚úÖ Atualiza√ß√£o autom√°tica conclu√≠da:', data.length, 'registros');
                
                const processedData = analyzeData(data);
                dashboardData = processedData;
                fullData = data;
                updateDashboard(processedData);
                
            } catch (error) {
                console.error('‚ùå Erro na atualiza√ß√£o autom√°tica:', error.message);
            }
        }

    </script>
</body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
